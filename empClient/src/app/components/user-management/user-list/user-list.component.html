<div class="container mt-3">
    <div class="col">
        <div class="row">
            <div class="col-xl-4 col-lg-6" *ngFor=" let sta of roleStatusCount|keyvalue">
                <div class="card">
                    <div class="card-statistic-3">
                        <div class="m-4">
                            <h5 class="card-title mb-0">{{sta.key}}</h5>
                        </div>
                        <div class="row align-items-center mb-2 d-flex">
                            <div class="col-8 px-4 pb-1">
                                <h2 class="d-flex align-items-center mb-0">
                                    {{sta.value}}
                                </h2>
                            </div>

                        </div>

                    </div>
                </div>
            </div>

        </div>
    </div>


</div>











<div class="container">

    <div class="table-responsive" id="pagerInfoTable">


        <div class="table-wrapper">
            <div class="table-title">
                <div class="row">
                    <div class="col-sm-6">
                        <h2>Manage <strong>users</strong></h2>
                    </div>
                    <div class="col-sm-6" *ngIf="role==2">
                        <button (click)="open(userAddModal)" class="btn btn-success">
                            <em class="bi bi-plus-circle-fill"></em>

                            &nbsp; Add user
                        </button>&nbsp;

                        <button [disabled]="!checkedUserIds.size" (click)="deleteUsers()" class="btn btn-danger">
                            <em class="bi-trash-fill"></em>
                            &nbsp;Delete Users
                        </button>

                        <button (click)="open(csvDowloadModal);" class="btn btn-danger">
                            <em class="bi bi-download"></em>
                            &nbsp;Download
                        </button>
                    </div>
                </div>
            </div>



            <div class="row">

                <div class="col-3">
                    Show

                    <div ngbDropdown #limitDropDown="ngbDropdown" class="d-inline-block">
                        <button type="button" class="btn btn-outline-secondary" id="dropdownBasic1" ngbDropdownToggle>
                            {{ limit?limit:"All"}}
                        </button>
                        <div ngbDropdownMenu aria-labelledby="dropdownBasic1 m-auto">
                            <button ngbDropdownItem (click)="limit=0;resetList()">All</button>
                            <button ngbDropdownItem (click)="limit=4;resetList()">4</button>
                            <button ngbDropdownItem (click)="limit=5;resetList()">5</button>
                            <hr>

                            <div class="d-flex">

                                <label class="mx-3 d-block">
                                    Enter Limit
                                </label>
                                <input (change)="resetList()" class="form-control-plaintext mx-3 my-0 d-inline d-block"
                                    style="width: 50px;" type="number" [(ngModel)]="limit" uplaceholder="Enter Limit"
                                    id="limitfield">
                            </div>
                        </div>
                    </div>

                    entries
                </div>


                <div class="col-auto">
                    <label for="filter">

                        <em class="bi bi-funnel-fill"></em>
                        Status : &nbsp;
                    </label>
                    <select id="filter" class="form-select w-auto d-inline" [(ngModel)]="selectedStatus"
                        (change)="resetList()">
                        <option selected="selected" [ngValue]="3">All</option>
                        <option *ngFor="let filter of status | keyvalue" [ngValue]="filter.key">{{filter.value}}
                        </option>

                    </select>

                </div>

                <div class="col-auto" *ngIf="role==2">
                    <label for="filter">

                        <em class="bi bi-person-fill"></em>
                        Roles : &nbsp;
                    </label>
                    <select id="filter" class="form-select w-auto d-inline" [(ngModel)]="selectedRole"
                        (change)="resetList()">
                        <option selected="selected" [ngValue]="3">All</option>
                        <option *ngFor="let filter of roles | keyvalue" [ngValue]="filter.key">{{filter.value}}
                        </option>

                    </select>

                </div>

                <div class="col-3 text-end">
                    <input placeholder="search" class="form-control w-auto d-inline align-self-end" type="text"
                        id="search" [(ngModel)]="search" (keyup)="resetList()" />
                </div>

            </div>


            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th scope="col">
                            <span class="custom-checkbox">
                                <input type="checkbox" id="selectAll" (change)="checkAll($event)"
                                    [checked]="checkAllButton()" />
                                <label for="selectAll"></label>
                            </span>
                        </th>



                        <th scope="col" (click)="setSort('userId')">Id
                            <button [disabled]="sortBy!='userId'" class="btn btn-sort bi "
                                [ngClass]="sortDesc ? 'bi-sort-numeric-up':'bi-sort-numeric-down'"></button>
                        </th>

                        <th scope="col" (click)="setSort('name')">Name
                            <button [disabled]="sortBy!='name'" class="btn btn-sort bi "
                                [ngClass]="sortDesc ? 'bi-sort-alpha-up':'bi-sort-alpha-down'"></button>
                        </th>

                        <th scope="col" (click)="setSort('userName')">User Name
                            <button [disabled]="sortBy!='userName'" class="btn btn-sort bi "
                                [ngClass]="sortDesc ? 'bi-sort-alpha-up':'bi-sort-alpha-down'"></button>
                        </th>
                        <th scope="col" (click)="setSort('email')">Email
                            <button [disabled]="sortBy!='email'" class="btn btn-sort bi "
                                [ngClass]="sortDesc ? 'bi-sort-alpha-up':'bi-sort-alpha-down'"></button>
                        </th>

                        <th scope="col" (click)="setSort('updateDate')">Last Update
                            <button [disabled]="sortBy!='updateDate'" class="btn btn-sort bi "
                                [ngClass]="sortDesc ? 'bi-sort-alpha-up':'bi-sort-alpha-down'"></button>
                        </th>

                        <th scope="col" (click)="setSort('status')">Status
                            <button [disabled]="sortBy!='status'" class="btn btn-sort bi "
                                [ngClass]="sortDesc ? 'bi-sort-alpha-up':'bi-sort-alpha-down'"></button>
                        </th>

                        <th scope="col" (click)="setSort('role')">Role
                            <button [disabled]="sortBy!='role'" class="btn btn-sort bi "
                                [ngClass]="sortDesc ? 'bi-sort-numeric-up':'bi-sort-numeric-down'"></button>
                        </th>

                        <th scope="col" style="min-width:130px ;">Actions</th>


                    </tr>
                </thead>

                <tbody *ngIf="userDataList">
                    <tr *ngIf="userDataList.length == 0">
                        <th class="text-center" id="NoRecordsFound" colspan="10">
                            No Records Found
                        </th>
                    </tr>
                    <tr *ngFor="let user of userDataList">
                        <td>
                            <span class="custom-checkbox">
                                <input type="checkbox" id="checkbox{{ user.userId }}" value="{{ user.userId }}"
                                    (change)="checkedUser($event)" [checked]="checkedUserIds.has(user.userId)" />
                                <label for="checkbox{{ user.userId }}"></label>
                            </span>
                        </td>
                        <td>{{ user.userId }}</td>
                        <td (click)="open(userDetailsModule);userId=user.userId">
                            {{ user.name }} 
                            <em class="bi bi-eye-fill mat-small mx-2"></em>
                        </td>
                        <td>{{ user.userName }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.updateDate | date : 'MMM-dd-YYYY h:mm a' : 'UTC+11'}}</td>
                        <td>
                            <p *ngIf="user.status == 0"><span class="badge bg-warning">{{status.get(user.status)
                                    }}</span></p>
                            <p *ngIf="user.status == 1"><span class="badge bg-success">{{ status.get(user.status)
                                    }}</span></p>
                            <p *ngIf="user.status == 2"><span class="badge bg-danger">{{status.get(user.status)
                                    }}</span></p>
                        </td>

                        <td>{{ roles.get(user.role) }}</td>

                        <td *ngIf="role==2">
                            <button placement="top" ngbTooltip="Edit user" class="btn"><a
                                    (click)="open(userEditModal);userId=user.userId"
                                    class="bi bi-pencil-fill edit"></a></button>
                            &nbsp;
                            <button *ngIf="user.status!=2" [disabled]="user.status==0" placement="top"
                                ngbTooltip="Delete User : {{user.name}}" class="btn btn-sort"
                                (click)="deleteUser(user.userId)">
                                <a class="bi bi-trash-fill delete"></a>
                            </button>

                            <button *ngIf="user.status==2" placement="top" ngbTooltip="Activate User : {{user.name}}"
                                class="btn" (click)="deleteUser(user.userId)">
                                <a class="bi bi-check2-square"></a>
                            </button>

                        </td>


                    </tr>



                    <tr *ngIf="!pagerInfo.hasNext && userDataList.length != 0">
                        <th class="text-center" id="NoRecordsFound" colspan="10">
                            End of Records
                        </th>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="clearfix" *ngIf="pagerInfo && limit">
        <div class="hint-text text-white">
            Showing
            <strong>{{ pagerInfo.itemStart }} </strong> to <strong> {{ pagerInfo.itemEnd }} </strong> out of
            <strong>{{ pagerInfo.count }}</strong> entries
        </div>

        <div>
            <ul class="pagination mb-5">

                <li class="page-item">

                    <label class=" text-white me-2 d-inline" style="font-size: 15px;"> Go to page</label>
                    <input class="page-link me-3 d-inline" style="width: 60px;" type="number" (change)="setPage($event)"
                        min="1" [max]="pagerInfo.numPages">
                </li>

                <li class="page-item" [class.disabled]="!pagerInfo.hasPrev">
                    <button class="page-link" (click)="gotoPage(1)">
                        First
                    </button>
                </li>
                <li class="page-item" [class.disabled]="!pagerInfo.hasPrev">
                    <button class="page-link" (click)="prevPage()"><em class="bi bi-caret-left-fill"></em></button>
                </li>

                <li class="page-item" *ngIf="pagerInfo.currentPage  > 3 && pagerInfo.numPages>5">
                    <button class="page-link" disabled>
                        ..
                    </button>
                </li>

                <li class="page-item" *ngFor="let s of numSeq(pagerInfo.numPages);"
                    [ngClass]="{ active: pagerInfo.currentPage == s }">
                    <button (click)="gotoPage(s)" class="page-link">
                        {{ s }}
                    </button>
                </li>

                <li class="page-item" *ngIf="pagerInfo.currentPage < pagerInfo.numPages - 2 && pagerInfo.numPages>5">
                    <button class="page-link" disabled>
                        ..
                    </button>
                </li>



                <li class="page-item" [class.disabled]="!pagerInfo.hasNext">
                    <button class="page-link" (click)="nextPage()"><em class="bi bi-caret-right-fill"></em></button>
                </li>

                <li class="page-item" [class.disabled]="!pagerInfo.hasNext">
                    <button class="page-link" (click)="gotoPage(pagerInfo.numPages)">
                        Last
                    </button>
                </li>
            </ul>

        </div>
    </div>
</div>



<ng-template #userEditModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title">Edit User Details</h4>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
    </div>
    <div class="modal-body">

        <app-admin-user-edit (completedEvent)="userEditComplete($event);modal.dismiss('Save')" #adminUserEditComponent
            [userId]="userId">
        </app-admin-user-edit>

    </div>
    <div class="modal-footer">
        <button class="btn btn-outline-success" (click)="adminUserEditComponent.update()"> Save
        </button>

    </div>
</ng-template>

<ng-template #userAddModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title">Register</h4>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
    </div>
    <div class="modal-body">

        <app-admin-user-add #adminUserAddComponent (completedEvent)="listUsers();modal.dismiss('Save')">
        </app-admin-user-add>

    </div>
    <div class="modal-footer">
        <button class="btn btn-outline-primary" (click)="adminUserAddComponent.register()"> Register
        </button>

    </div>
</ng-template>


<ng-template #csvDowloadModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title">Select Options</h4>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
    </div>
    <div class="modal-body">

        <div class="row">

            <div class="col-6">

                <label class="form-label">
                    <strong>Roles</strong>
                </label>
                <div *ngFor="let role of roles|keyvalue">
                    <input type="checkbox" (change)="changeCsvStat($event,role.key,csvData.roles)"
                        [checked]="csvData.roles.has(role.key)"
                        [disabled]="csvData.roles.size==1 && csvData.roles.has(role.key)">
                    {{role.value}}
                </div>

            </div>
            <div class="col-6">
                <label class="form-label">
                    <strong>Status</strong>
                </label>

                <div class="col-6" *ngFor="let stat of status|keyvalue">
                    <input type="checkbox" (change)="changeCsvStat($event,stat.key,csvData.status)"
                        [checked]="csvData.status.has(stat.key)"
                        [disabled]="csvData.status.size==1 && csvData.status.has(stat.key)">
                    {{stat.value}}
                </div>
            </div>
            <hr class="mt-2">

            <div class="col-6">
                <label for="startDate" class="form-label d-inline me-2">Start</label>
                <input [max]="today" onkeydown="return false" [formControl]="csvData.startDate" id="startDate"
                    type="date" class="form-control w-75 d-inline">

                <div class="text-danger" *ngIf="csvData.startDate.errors?.['required'] && csvData.startDate.touched ">
                    Select Start date
                </div>

            </div>

            <div class="col-6">

                <label for="startDate" class="form-label  d-inline me-2">End</label>
                <input [max]="today" onkeydown="return false" [formControl]="csvData.endDate" type="date"
                    class="form-control w-75  d-inline">

                <div class="text-danger" *ngIf="csvData.endDate.errors?.['required'] ">
                    Select End date
                </div>
            </div>


        </div>

    </div>
    <div class="modal-footer">
        <button class="btn btn-outline-primary" (click)="downloadCsv()"> Download
        </button>

    </div>
</ng-template>

<!-- Spinner -->
<div *ngIf="showSpinner" class="loading">Loading&#8230;</div>



<div class="search-results" infinite-scroll [infiniteScrollDistance]="scrollDistance"
    [infiniteScrollUpDistance]="scrollUpDistance" [infiniteScrollThrottle]="throttle" (scrolled)="onScrollDown()"
    (scrolledUp)="onUp()">

</div>

<ng-template #userDetailsModule let-modal>
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title">User Details</h4>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss('Cross click')"></button>
    </div>
    <div class="modal-body">
        <app-user-detail [userId]="userId"></app-user-detail>
    </div>
</ng-template>